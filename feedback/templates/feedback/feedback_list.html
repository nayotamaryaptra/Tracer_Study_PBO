{% extends 'base.html' %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-success"><i class="bi bi-megaphone-fill"></i> Aspirasi & Feedback</h2>
        <p class="text-muted mb-0">Sampaikan masukan untuk kemajuan bersama.</p>
    </div>
    {% if not is_admin %}
        <a href="{% url 'feedback:create' %}" class="btn btn-success shadow-sm px-4 rounded-pill">
            <i class="bi bi-plus-lg me-1"></i> Buat Tiket Baru
        </a>
    {% endif %}
</div>

{% if is_admin %}
<div class="card border-0 shadow-sm mb-4 bg-white">
    <div class="card-body py-3">
        <form method="get" class="row g-2 align-items-center">
            <div class="col-auto fw-bold text-muted small"><i class="bi bi-funnel-fill"></i> FILTER:</div>
            <div class="col-md-3">
                <select name="kategori" class="form-select form-select-sm border-0 bg-light fw-medium">
                    <option value="">-- Semua Kategori --</option>
                    {% for k, label in kategori_list %}<option value="{{ k }}">{{ label }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select form-select-sm border-0 bg-light fw-medium">
                    <option value="">-- Semua Status --</option>
                    {% for s, label in status_list %}<option value="{{ s }}">{{ label }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-success px-3 rounded-pill shadow-sm">Cari</button>
                <a href="{% url 'feedback:list' %}" class="btn btn-sm btn-link text-decoration-none text-muted">Reset</a>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div class="row g-4">
    {% for f in feedbacks %}
    <div class="col-md-6">
        <div class="card h-100 border-0 shadow-sm rounded-4 hover-shadow position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 bottom-0 bg-{{ f.status|yesno:'secondary,warning,success' }}" style="width: 5px;"></div>
            
            <div class="card-body p-4 ps-5">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="badge bg-light text-dark border rounded-pill fw-normal">
                        <i class="bi bi-tag-fill me-1 text-muted"></i> {{ f.get_kategori_display }}
                    </span>
                    
                    {% if f.status == 'pending' %}
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary rounded-pill">Menunggu</span>
                    {% elif f.status == 'process' %}
                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning rounded-pill">Diproses</span>
                    {% else %}
                        <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill">Selesai</span>
                    {% endif %}
                </div>

                <h5 class="fw-bold text-dark mb-1">{{ f.mata_kuliah }}</h5>
                
                <div class="mb-3 text-warning">
                    {% for i in "12345" %}
                        {% if forloop.counter <= f.rating %}
                            <i class="bi bi-star-fill"></i>
                        {% else %}
                            <i class="bi bi-star text-muted opacity-25"></i>
                        {% endif %}
                    {% endfor %}
                    <span class="text-muted small ms-2">({{ f.rating }}/5)</span>
                </div>

                <p class="text-muted mb-4 bg-light p-3 rounded-3 fst-italic">
                    "{{ f.saran }}"
                </p>

                <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                            {% if f.is_anonymous %}
                                <i class="bi bi-incognito text-dark fs-5"></i>
                            {% else %}
                                <span class="fw-bold text-primary">{{ f.alumni.nama|slice:":1" }}</span>
                            {% endif %}
                        </div>
                        <div class="small">
                            {% if f.is_anonymous %}
                                <span class="fw-bold text-dark">Mahasiswa (Anonim)</span>
                                {% if is_admin %}<br><span class="text-muted fst-italic" style="font-size: 0.7rem;">(Asli: {{ f.alumni.nama }})</span>{% endif %}
                            {% else %}
                                <span class="fw-bold text-dark">{{ f.alumni.nama }}</span>
                                <br><span class="text-muted">{{ f.alumni.prodi.nama }}</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if is_admin %}
                    <form method="post" class="d-flex align-items-center">
                        {% csrf_token %}
                        <input type="hidden" name="feedback_id" value="{{ f.id }}">
                        <select name="status" class="form-select form-select-sm border-0 bg-light me-2" style="width: 110px;" onchange="this.form.submit()">
                            <option value="pending" {% if f.status == 'pending' %}selected{% endif %}>Menunggu</option>
                            <option value="process" {% if f.status == 'process' %}selected{% endif %}>Proses</option>
                            <option value="done" {% if f.status == 'done' %}selected{% endif %}>Selesai</option>
                        </select>
                        <a href="{% url 'feedback:delete' f.pk %}" class="btn btn-sm btn-outline-danger border-0 rounded-circle"><i class="bi bi-trash"></i></a>
                    </form>
                    {% else %}
                        <div>
                            <a href="{% url 'feedback:edit' f.pk %}" class="btn btn-sm btn-link text-warning p-0 me-2"><i class="bi bi-pencil-square fs-5"></i></a>
                            <a href="{% url 'feedback:delete' f.pk %}" class="btn btn-sm btn-link text-danger p-0"><i class="bi bi-trash fs-5"></i></a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12 text-center py-5">
        <div class="text-muted opacity-50 mb-3"><i class="bi bi-inbox fs-1"></i></div>
        <p class="text-muted">Belum ada aspirasi yang masuk.</p>
    </div>
    {% endfor %}
</div>

<style>
    .hover-shadow:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important; transition: all 0.3s ease; }
</style>
{% endblock %}